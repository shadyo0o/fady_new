# Dashboard & Next-Vaccine Page Data Synchronization

## Overview

The Dashboard (Home page) card now displays identical information to the Next-Vaccine detail page through unified data fetching and processing logic.

## Implementation Changes

### 1. Unified Title Grouping

**Dashboard Card Title:**
- Before: Showed only vaccine count (e.g., "2 تطعيمات معاً")
- After: Shows all vaccine titles joined by " + " (e.g., "تحليل الغدة والسمع + BCG - الدرن + الجرعة الصفرية (شلل أطفال)")

**Code Location:** `/components/cards/SmartVisitPackageCard.js` (lines 94-102)

```javascript
<h3 className="text-base font-bold mb-2 line-clamp-3 leading-snug">
  {vaccineTitles && vaccineTitles.length > 0
    ? vaccineTitles.join(' + ')
    : 'تطعيم قادم'}
</h3>
```

This uses the same `vaccineTitles` array generated by `createVisitPackage()` utility function.

### 2. Synchronized Due Date

**Date Format:** Both pages now use `YYYY-MM-DD` format (e.g., "2026-02-03")

**Implementation:**
- The `normalizeDateForComparison()` function in `vaccineGrouping.js` converts all date formats to `YYYY-MM-DD`
- The `createVisitPackage()` function returns the formatted date
- Both Dashboard and NextVaccine use this same utility

**Code Location:** `/lib/utils/vaccineGrouping.js` (lines 39-50)

```javascript
export const normalizeDateForComparison = (dateValue) => {
  const parsedDate = parseArabicDate(dateValue);
  if (!parsedDate) return '';
  
  const year = parsedDate.getFullYear();
  const month = String(parsedDate.getMonth() + 1).padStart(2, '0');
  const day = String(parsedDate.getDate()).padStart(2, '0');
  
  return `${year}-${month}-${day}`;
};
```

### 3. Static Warning Alerts for Unavailable Vaccines

**Dashboard Card Warning Display:**
- Displays each unavailable vaccine (e.g., BCG) in a separate orange/red warning box
- Shows the vaccine title, office, and specific warning message
- Replaces the general advice section when unavailability is detected

**Code Location:** `/components/cards/SmartVisitPackageCard.js` (lines 132-157)

```javascript
{/* Static Warning Alert for Unavailable Vaccines */}
{unavailableVaccines && unavailableVaccines.length > 0 && (
  <div className="mt-3 pt-3 border-t border-white/10 relative z-10 space-y-2">
    {unavailableVaccines.map((vaccine, idx) => (
      <div key={idx} className="bg-orange-500/40 backdrop-blur-sm rounded-lg p-3 border border-orange-300/60 animate-pulse">
        <div className="flex items-start gap-2">
          <AlertCircle className="w-4 h-4 text-orange-50 mt-0.5 flex-shrink-0" />
          <div className="flex-1">
            <p className="text-xs font-bold text-orange-50 leading-relaxed">
              ❌ {vaccine.title} غير متوفر في {office || 'المكتب الصحي'}
            </p>
            {vaccine.warning && (
              <p className="text-xs text-orange-100 mt-1 leading-relaxed">
                {vaccine.warning}
              </p>
            )}
          </div>
        </div>
      </div>
    ))}
  </div>
)}
```

**Example Output:**
```
❌ BCG - الدرن غير متوفر في مكتب صحة طبي سعد ورعايه طفل شبرا
⚠️ متوفر فى صحة اول مديرية الصحة يوم السبت فقط
⚠️ متوفر فى باقي المكاتب يومي السبت و الثلاثاء
```

### 4. Data Consistency Between Pages

#### Dashboard Fetching (`/app/dashboard/page.js`)

1. Fetches dashboard data with children list
2. For each child, calls `/childs/getNextVaccine/{childId}`
3. Extracts both `nextTask` and `nextVaccines` array
4. Passes both to `createVisitPackage()` utility
5. Returns unified visit package data to `SmartVisitPackageCard`

```javascript
const nextTask = vaccineData?.nextTask || vaccineData?.nextVaccine;
const nextVaccines = vaccineData?.nextVaccines || (nextTask ? [nextTask] : []);

// Create the smart visit package with grouped vaccines
const visitPackage = createVisitPackage(
  earliest.nextVaccines,
  earliest.nextTask
);
```

#### NextVaccine Detail Fetching (`/app/next-vaccine/page.js`)

1. Fetches data from `/childs/getNextVaccine/{childId}`
2. Extracts same `nextTask` and `nextVaccines` fields
3. Passes same data to `createVisitPackage()` utility
4. Displays detailed view with grouped information

```javascript
const nextTask = data?.nextTask || data?.nextVaccine;
const nextVaccines = data?.nextVaccines || (nextTask ? [nextTask] : []);

if (nextTask) {
  visitPackage = createVisitPackage(nextVaccines, nextTask);
}
```

## Data Flow Diagram

```
Backend API: /childs/getNextVaccine/{childId}
    ↓
    └─ Returns: {
         nextTask: { ... },
         nextVaccines: [ ... ],
         ...
       }
    ↓
Dashboard.js & NextVaccine.js (Same extraction)
    ↓
    └─ Both extract:
       - nextTask (primary vaccine)
       - nextVaccines (array of vaccines on same date)
    ↓
createVisitPackage(nextVaccines, nextTask)
    ↓
    └─ Groups vaccines by date
    └─ Filters unavailable vaccines
    └─ Formats date to YYYY-MM-DD
    └─ Merges warnings
    └─ Returns unified package:
       {
         date: "2026-02-03",
         day: "الثلاثاء",
         vaccineTitles: ["تحليل الغدة والسمع", "BCG - الدرن", "الجرعة الصفرية"],
         allVaccines: [...],
         unavailableVaccines: [...],
         warnings: [...]
       }
    ↓
SmartVisitPackageCard (Dashboard) || NextVaccine Detail Page
    ↓
    └─ Display unified information
```

## Key Functions Used

### `createVisitPackage(nextVaccines, nextTask)`
- **Location:** `/lib/utils/vaccineGrouping.js`
- **Purpose:** Groups vaccines by date and creates unified visit package
- **Inputs:**
  - `nextVaccines`: Array of all vaccines on the same date
  - `nextTask`: Primary/first vaccine in the package
- **Outputs:**
  - Unified visit package with grouped titles, warnings, and availability info
  - Date formatted to YYYY-MM-DD
  - All unavailable vaccines flagged

### `normalizeDateForComparison(dateValue)`
- **Location:** `/lib/utils/vaccineGrouping.js`
- **Purpose:** Converts any date format to YYYY-MM-DD
- **Used by:** `createVisitPackage()` for consistent date comparison

### `formatVaccineWarnings(vaccines)`
- **Location:** `/lib/utils/vaccineGrouping.js`
- **Purpose:** Structures vaccine warnings for consistent display
- **Returns:** Array of formatted warning objects

## Testing & Verification

To verify data consistency between Dashboard and NextVaccine pages:

1. **Check Title Sync:**
   - Dashboard card title = NextVaccine page title
   - Both should show all vaccines joined by " + "

2. **Check Date Sync:**
   - Dashboard shows date in format: "2026-02-03"
   - NextVaccine shows same date in "الموعد المحدد" section
   - Both use `normalizeDateForComparison()` utility

3. **Check Warnings Sync:**
   - Unavailable vaccines display in orange/red boxes on Dashboard
   - Same warnings appear in detail page's "حزمة الزيارة الموحدة" section
   - Warning text matches exactly

4. **Check Office Consistency:**
   - Both pages show same office name
   - Both fetch from same API endpoint

## No Breaking Changes

This refactoring:
- ✅ Maintains backward compatibility
- ✅ Uses existing API endpoints
- ✅ Doesn't modify backend data structures
- ✅ Safe to deploy immediately
- ✅ Zero downtime implementation
